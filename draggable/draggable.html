<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>TESTING DRAGGABLES</title>

		<style>
			.wrapper {
				display: flex;
				gap: 40px;
			}
			.container {
				display: flex;
				flex-direction: column;
				gap: 8px;
				width: 200px;
				min-height: 150px;
				padding: 10px;
				border: 2px dashed #bbb;
				border-radius: 6px;
				background: #f9f9f9;
			}
			.item {
				padding: 10px;
				border: 1px solid #999;
				background: #eee;
				cursor: grab;
			}
			.dragging {
				opacity: 0.5;
			}
			.counter {
				margin-top: 10px;
				font-weight: bold;
				color: #555;
			}
		</style>
	</head>
	<body>
		<div class="wrapper">
			<div>
				<div class="container" id="container1">
					<div class="item" draggable="true" data-id="mike">Item 1</div>
					<div class="item" draggable="true" data-id="jude">Item 2</div>
					<div class="item" draggable="true" data-id="scott">Item 3</div>
				</div>
				<div class="counter" id="counter1"></div>
			</div>

			<div>
				<div class="container" id="container2">
					<div class="item" draggable="true" data-id="ken">Item 1</div>
					<div class="item" draggable="true" data-id="marie">Item 2</div>
				</div>
				<div class="counter" id="counter2"></div>
			</div>

			<div>
				<div class="container" id="container3"></div>
				<div class="counter" id="counter3"></div>
			</div>
		</div>

		<script>
			const containers = document.querySelectorAll(".container");

			containers.forEach((container) => {
				container.addEventListener("dragstart", (e) => {
					e.target.classList.add("dragging");

					// Store original position + container in sessionStorage
					const position = e.target.dataset.position || "unknown";
					const containerId = e.target.parentElement.id;
					sessionStorage.setItem("draggedId", e.target.dataset.id);
					sessionStorage.setItem("originalPosition", position);
					sessionStorage.setItem("originalContainer", containerId);
				});

				container.addEventListener("dragover", (e) => {
					e.preventDefault(); // required to allow dropping
					const dragging = document.querySelector(".dragging");
					const afterElement = getDragAfterElement(container, e.clientY);
					if (afterElement == null) {
						container.appendChild(dragging);
					} else {
						container.insertBefore(dragging, afterElement);
					}
				});

				container.addEventListener("drop", (e) => {
					e.preventDefault();
					const dragging = document.querySelector(".dragging");
					if (dragging) {
						dragging.classList.remove("dragging");
					}
					updateAll();

					// Compare original vs new
					if (dragging) {
						const newPosition = dragging.dataset.position;
						const newContainer = dragging.parentElement.id;
						// console.log(`Record Id ${dragging.dataset.id} : old index ${sessionStorage.getItem("originalPosition")} in ${sessionStorage.getItem("originalContainer")} to new index ${newPosition} in${newContainer}`);
						// console.dir("DATASET: " + `${dragging.dataset}`);
						console.log("LOOKING INSIDE THE DATASET:", JSON.stringify(dragging.dataset));
						console.log("Record Id: " + `${dragging.dataset.id}`);
						console.log("Old Continer: " + `${sessionStorage.getItem("originalContainer")}`);
						console.log("Old Index: " + ` ${sessionStorage.getItem("originalPosition")}`);
						console.log("New Container: " + `${newContainer}`);
						console.log("New Index: " + `${newPosition}`);
					}
				});
			});

			function getDragAfterElement(container, y) {
				const draggableElements = [...container.querySelectorAll(".item:not(.dragging)")];
				return draggableElements.reduce(
					(closest, child) => {
						const box = child.getBoundingClientRect();
						const offset = y - box.top - box.height / 2;
						if (offset < 0 && offset > closest.offset) {
							return { offset: offset, element: child };
						} else {
							return closest;
						}
					},
					{ offset: Number.NEGATIVE_INFINITY }
				).element;
			}

			function renumberItems(container, counterId) {
				const items = container.querySelectorAll(".item");
				items.forEach((item, index) => {
					const position = index + 1;
					item.dataset.position = position; // update data-position
					item.textContent = `Item ${position} (id=${item.dataset.id})`;
				});
				document.getElementById(counterId).textContent = `Total items: ${items.length}`;
			}

			function updateAll() {
				renumberItems(document.getElementById("container1"), "counter1");
				renumberItems(document.getElementById("container2"), "counter2");
				renumberItems(document.getElementById("container3"), "counter3");
			}

			// Initialize on page load
			updateAll();
		</script>
	</body>
</html>
